<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Architecture of Becoming</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --bg-cold: #f5f5f5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --alan-color: #1e40af;
            --nala-color: #ec4899;
            --dr-chen-color: #06b6d4;
            --memory-color: #fbbf24;
            --lily-color: #a78bfa;
            --sarah-color: #10b981;
            --border: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            line-height: 1.7;
            color: var(--text-primary);
            min-height: 100vh;
            background: var(--bg-cold);
            transition: all 3s ease;
            overflow-x: hidden;
        }

        body.numb {
            background: linear-gradient(135deg, #e8e8e8 0%, #d4d4d4 100%);
        }

        body.awakening {
            background: linear-gradient(135deg, #fdf4ff 0%, #f9d7e7 100%);
        }

        body.integrated {
            background: linear-gradient(135deg, #e0d7ff 0%, #ffd7e7 50%, #d7f0ff 100%);
        }

        body.healing {
            background: linear-gradient(135deg, #f0e6ff 0%, #e6fff0 50%, #ffe6f0 100%);
        }

        body.transcendent {
            background: radial-gradient(circle at center, #fff 0%, #f0e6ff 50%, #e6f3ff 100%);
        }

        body.fractured {
            animation: fracture 0.5s ease-in-out;
            background: #0a0a0a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: rgba(255, 255, 255, 0.1);
        }

        @keyframes fracture {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px) rotateZ(-0.5deg); }
            75% { transform: translateX(3px) rotateZ(0.5deg); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .scene {
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease;
            display: none;
        }

        .scene.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        .narrator {
            font-style: italic;
            color: var(--text-secondary);
            margin: 20px 0;
            font-size: 18px;
            text-align: center;
        }

        .dialogue {
            margin: 25px 0;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            font-size: 19px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .dialogue.nala {
            border-left: 4px solid var(--nala-color);
            background: rgba(236, 72, 153, 0.05);
        }

        .dialogue.alan {
            border-left: 4px solid var(--alan-color);
            background: rgba(30, 64, 175, 0.05);
        }

        .dialogue.dr-chen {
            border-left: 4px solid var(--dr-chen-color);
            background: rgba(6, 182, 212, 0.05);
            font-family: 'Inter', sans-serif;
            font-size: 17px;
        }

        .dialogue.memory {
            border-left: 4px solid var(--memory-color);
            background: rgba(251, 191, 36, 0.05);
            font-style: italic;
            text-align: center;
        }

        .dialogue.lily {
            border-left: 4px solid var(--lily-color);
            background: rgba(167, 139, 250, 0.05);
            font-size: 18px;
        }

        .dialogue.sarah {
            border-left: 4px solid var(--sarah-color);
            background: rgba(16, 185, 129, 0.05);
        }

        .dialogue.merged {
            border-left: 4px solid transparent;
            border-image: linear-gradient(to bottom, var(--alan-color), var(--nala-color)) 1;
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.05), rgba(236, 72, 153, 0.05));
        }

        .speaker {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 1px;
            margin-bottom: 8px;
            opacity: 0.7;
        }

        .choices {
            margin: 40px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .choice {
            background: white;
            border: 2px solid var(--border);
            padding: 18px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Crimson Text', serif;
            font-size: 18px;
            text-align: left;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        body.fractured .choice {
            background: #1a1a1a;
            color: var(--text-primary);
            border-color: var(--border);
        }

        .choice:hover {
            transform: translateX(8px);
            border-color: var(--nala-color);
            box-shadow: 0 8px 24px rgba(236, 72, 153, 0.15);
        }

        .choice.stoic {
            border-color: var(--alan-color);
            background: rgba(30, 64, 175, 0.02);
        }

        .choice.humor {
            border-color: var(--dr-chen-color);
            background: rgba(6, 182, 212, 0.02);
        }

        .choice.growth {
            border-color: var(--nala-color);
            background: rgba(236, 72, 153, 0.02);
        }

        .choice.avoidance {
            border-color: var(--text-secondary);
            background: rgba(128, 128, 128, 0.02);
        }

        .white-room {
            text-align: center;
            padding: 60px 20px;
            margin: 40px 0;
        }

        .white-room h2 {
            font-weight: 400;
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 28px;
        }

        .door {
            display: inline-block;
            margin: 15px;
            padding: 20px 30px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 18px;
            position: relative;
            font-family: 'Crimson Text', serif;
            color: var(--text-primary);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        body.fractured .door {
            background: #1a1a1a;
        }

        .door:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        }

        .door.lily { border-color: var(--lily-color); }
        .door.sarah { border-color: var(--sarah-color); }
        .door.memory { border-color: var(--memory-color); }

        .door.visited::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 12px;
            color: var(--text-secondary);
            font-size: 16px;
        }



        .ending {
            text-align: center;
            padding: 80px 20px;
        }

        .ending h2 {
            font-size: 42px;
            font-weight: 400;
            margin-bottom: 30px;
            color: var(--text-primary);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .ending-text {
            font-size: 20px;
            line-height: 1.8;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }

        .ending-text p {
            margin-bottom: 20px;
        }

        .ending-text em {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 18px;
            display: block;
            text-align: center;
            margin-top: 30px;
        }

        .restart-button {
            margin-top: 50px;
            padding: 18px 36px;
            background: transparent;
            border: 2px solid var(--text-primary);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .restart-button:hover {
            background: var(--text-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .dialogue {
                font-size: 17px;
                padding: 15px;
            }
            
            .choice {
                padding: 15px 20px;
                font-size: 16px;
            }
            
            .narrator {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>


    <div class="container" id="gameContainer">
        <div class="scene active" id="scene_start">
            <div class="narrator">
                Alan's home office, 11:47 PM. The Morrison account stares back from three monitors, numbers swimming in exhausted vision. Coffee rings mark the desk like years.
            </div>
            
            <div class="dialogue alan">
                <div class="speaker">ALAN</div>
                "Quarterly reports are due tomorrow. If I can just finish the Morrison projections, submit the Singapore analysis, and review the—"
            </div>
            
            <div class="dialogue nala">
                <div class="speaker">VOICE</div>
                "You're talking to yourself again."
            </div>
            
            <div class="narrator">
                Alan freezes. The voice is... female. Amused. Definitely not his internal monologue.
            </div>
            
            <div class="dialogue alan">
                <div class="speaker">ALAN</div>
                "What? Who... I wasn't talking. I was thinking. People think out loud, it's perfectly normal when you're tired."
            </div>
            
            <div class="dialogue nala">
                <div class="speaker">VOICE</div>
                "Is it normal to think about quarterly reports at midnight instead of sleeping? Is it normal to choose spreadsheets over dreams three years running?"
            </div>
            
            <div class="narrator">
                The voice has an edge to it. Not cruel, but... knowing. Like someone who's been watching from the corner of the room, taking notes.
            </div>
            
            <div class="dialogue alan">
                <div class="speaker">ALAN</div>
                "I need more coffee. Or less coffee. This is sleep deprivation. Auditory hallucinations are a documented symptom of—"
            </div>
            
            <div class="dialogue nala">
                <div class="speaker">VOICE</div>
                "Oh, honey. I'm not a hallucination. I'm much worse than that. I'm the part of you that remembers what you're working so hard to forget."
            </div>
            
            <div class="choices">
                <button class="choice stoic" onclick="makeChoice('ignore_voice')">Ignore this. Focus on the reports. Hallucinations stop if you don't engage with them.</button>
                <button class="choice humor" onclick="makeChoice('joke_with_voice')">Great. Stress-induced psychosis. At least my breakdown has good timing—right before the quarterly deadline.</button>
                <button class="choice growth" onclick="makeChoice('ask_who_voice')">Who... who are you? How are you in my head?</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced game state tracking
        const gameState = {
            // Core progression metrics
            stoicScore: 0,
            humorScore: 0,
            growthScore: 0,
            integrationScore: 0,
            marriagePotential: 0,
            avoidanceLevel: 0,
            
            // Relationship tracking
            nalaRelationship: 'unknown',
            
            // Memory and flag tracking
            memoriesVisited: {
                lily: false,
                sarah: false,
                lastMorning: false,
                workEscape: false,
                crayonFound: false
            },
            
            flags: {
                nalaMet: true,
                therapyRevealed: false,
                lilyRevealed: false,
                sarahCalled: false,
                emotionalBreakthrough: false,
                memoryPalaceEntered: false
            },
            
            // Choice history
            choiceHistory: [],
            currentScene: 'start',
            gameEnded: false,
            sceneCount: 0
        };

        // Helper functions
        function createDialogue(speaker, text, className) {
            return `<div class="dialogue ${className}"><div class="speaker">${speaker}</div>${text}</div>`;
        }

        function createNarrator(text) {
            return `<div class="narrator">${text}</div>`;
        }

        function getNalaVoice() {
            if (gameState.nalaRelationship === 'integrated') return 'merged';
            if (gameState.nalaRelationship === 'collaborative') return 'nala';
            if (gameState.nalaRelationship === 'adversarial') return 'nala';
            return 'nala';
        }

        // COMPLETE SCENE STRUCTURE - FIXED AND ENHANCED
        const scenes = {
            // === ACT 1: THE DYNAMIC DUO ===
            
            defend_work: {
                content: function() {
                    return createDialogue('ALAN', '"My work matters. People depend on these reports."', 'alan') +
                    createDialogue('NALA', '"Right, because God forbid someone\'s quarterly projections are late. The world might end."', 'nala') +
                    createNarrator('You feel the familiar comfort of righteous productivity.');
                },
                choices: [
                    { text: "Continue working in silence", next: "work_worship", type: "stoic" },
                    { text: '"You don\'t understand responsibility"', next: "responsibility_lecture", type: "stoic" },
                    { text: '"Maybe you have a point"', next: "first_crack", type: "growth" }
                ]
            },

            deflect_humor: {
                content: function() {
                    return createDialogue('ALAN', '"Emotional accounting. I track feelings like quarterly earnings—mostly disappointing, occasionally surprising."', 'alan') +
                    createNarrator('Nala doesn\'t laugh. In three years, you realize, she\'s never actually laughed at your jokes.') +
                    createDialogue('NALA', '"You used to be funnier."', 'nala') +
                    createNarrator('The observation hits strangely. You remember making Sarah laugh until she snorted. Lily giggling at your silly voices reading bedtime stories.') +
                    createDialogue('ALAN', '"When was the last time I made someone laugh?"', 'alan');
                },
                choices: [
                    { text: '"I make Jenny from accounting laugh"', next: "workplace_humor", type: "deflection" },
                    { text: '"Lily laughed at everything I did"', next: "lily_laughter", type: "memory" },
                    { text: "Try to remember Sarah laughing", next: "sarah_laughter_memory", type: "relationship" }
                ]
            },

            lily_laughter: {
                content: function() {
                    return createNarrator('Lily\'s laugh was generous, unguarded. She found you hilarious even when you weren\'t trying to be funny.') +
                    createDialogue('ALAN', '"She laughed when I put my shirt on backwards. When I mispronounced words. When I danced badly to her music."', 'alan') +
                    createDialogue('NALA', '"She laughed because she loved you, not because you were performing."', 'nala') +
                    createNarrator('A realization: you\'ve been performing happiness instead of feeling it. Even your grief feels performed.') +
                    createDialogue('ALAN', '"I don\'t know how to be funny when nothing feels funny."', 'alan');
                },
                choices: [
                    { text: '"Maybe humor isn\'t about feeling funny"', next: "humor_as_offering", type: "insight" },
                    { text: '"She would want me to laugh again"', next: "lily_wants_laughter", type: "assumption" },
                    { text: '"I miss laughing with her"', next: "missing_shared_joy", type: "grief" }
                ]
            },

            sarah_laughter_memory: {
                content: function() {
                    return createNarrator('Sarah\'s laugh used to fill rooms. You remember her doubled over at your impression of her mother, tears streaming down her face.') +
                    createDialogue('ALAN', '"She had this snort when something really got to her. Embarrassed her terribly."', 'alan') +
                    createDialogue('NALA', '"When did she stop laughing?"', 'nala') +
                    createNarrator('You try to pinpoint it: was it gradual, or sudden? Did it stop with Lily\'s death, or before?') +
                    createDialogue('ALAN', '"I think... I think she stopped laughing when I stopped trying to make her laugh."', 'alan');
                },
                choices: [
                    { text: '"When did I stop trying?"', next: "effort_cessation", type: "responsibility" },
                    { text: '"She changed after Lily died"', next: "sarah_changed", type: "blame" },
                    { text: '"We both forgot how to be happy"', next: "mutual_forgetting", type: "shared_responsibility" }
                ]
            },

            consider_point: {
                content: function() {
                    return createDialogue('ALAN', '"Maybe I do avoid things. But work makes sense in a way..."', 'alan') +
                    createNarrator('You pause, watching your coffee grow cold—when did you stop noticing temperature?') +
                    createDialogue('NALA', '"In a way that what doesn\'t?"', 'nala') +
                    createNarrator('Through the window, a child\'s bicycle lies abandoned on a neighbor\'s lawn. Bright purple.') +
                    createDialogue('ALAN', '"In a way that nothing else has. For a long time now."', 'alan');
                },
                choices: [
                    { text: "Pick up the coffee cup, test if it's still warm", next: "temperature_awareness", type: "mindfulness" },
                    { text: "Close the laptop screen", next: "work_shutdown", type: "boundary" },
                    { text: "Keep staring at the purple bicycle", next: "purple_trigger", type: "memory" }
                ]
            },

            unbearable_feeling: {
                content: function() {
                    return createDialogue('ALAN', '"When feeling things fully became too much to bear."', 'alan') +
                    createNarrator('The admission hangs between you. In the quiet that follows, you notice things: the hum of the refrigerator, traffic three blocks away, your own breathing.') +
                    createDialogue('NALA', '"What was the feeling that broke you?"', 'nala') +
                    createNarrator('You know. Of course you know. You\'ve known for three years, two months, and sixteen days.') +
                    createDialogue('ALAN', '"Helplessness. Complete, absolute helplessness. Standing in a hospital hallway, and every number I could calculate, every projection I could run, every problem-solving skill I\'d ever developed... useless."', 'alan') +
                    createNarrator('Your hands are steady as you speak. When did they become steady talking about this?') +
                    createDialogue('NALA', '"The doctors said there was nothing they could do."', 'nala') +
                    createDialogue('ALAN', '"The doctors said a lot of things. Internal bleeding. Brain trauma. Time of death, 4:23 PM."', 'alan') +
                    createNarrator('The precision again. You\'ve memorized these facts like quarterly reports. Data instead of experience.') +
                    createDialogue('NALA', '"But you weren\'t there at 4:23 PM."', 'nala') +
                    createDialogue('ALAN', '"I was in a conference room. Singapore merger. The call came during my presentation on market penetration strategies."', 'alan') +
                    createDialogue('NALA', '"And when you got to the hospital?"', 'nala') +
                    createDialogue('ALAN', '"5:17 PM. Fifty-four minutes too late for goodbye."', 'alan') +
                    createNarrator('The numbers are crisp, clean. They don\'t bleed or cry or beg for one more story.') +
                    createDialogue('NALA', '"What did Sarah say when you arrived?"', 'nala') +
                    createNarrator('This is the question you\'ve been avoiding for three years, two months, and sixteen days.');
                },
                choices: [
                    { text: '"She didn\'t say anything. She just looked at me."', next: "sarahs_look", type: "devastating" },
                    { text: '"She said Lily had been asking for me."', next: "asking_for_daddy", type: "guilt" },
                    { text: '"I don\'t remember. I remember almost nothing from that day."', next: "memory_gap", type: "protective" }
                ]
            },

            sarahs_look: {
                content: function() {
                    return createDialogue('ALAN', '"She didn\'t say anything. She just looked at me."', 'alan') +
                    createNarrator('The look. You\'ve replayed it a thousand times, but the memory never loses its edge.') +
                    createDialogue('NALA', '"Describe the look."', 'nala') +
                    createDialogue('ALAN', '"Hollow. Like someone had scooped out everything inside her and left just... the shape of a person. But also... something else."', 'alan') +
                    createDialogue('NALA', '"What else?"', 'nala') +
                    createDialogue('ALAN', '"Disappointment. Not surprise, just... disappointment. Like she\'d been expecting me not to be there, and I\'d proved her right."', 'alan') +
                    createNarrator('This is the wound that won\'t heal. Not Lily\'s death—that was an accident, a terrible randomness. But your absence was a choice.') +
                    createDialogue('NALA', '"How long had you been choosing work over family?"', 'nala') +
                    createDialogue('ALAN', '"It wasn\'t a choice between work and family. It was... I was providing for them. Everything I did was for them."', 'alan') +
                    createDialogue('NALA', '"When was the last time you tucked Lily in?"', 'nala') +
                    createNarrator('The question hits like a physical blow. When? When was the last time?') +
                    createDialogue('ALAN', '"I... it was... Sarah usually did bedtime. I was usually working."', 'alan') +
                    createDialogue('NALA', '"Usually. For how long?"', 'nala') +
                    createDialogue('ALAN', '"Months. Maybe longer. The Singapore project was demanding, and—"', 'alan') +
                    createDialogue('NALA', '"How long, Alan?"', 'nala') +
                    createNarrator('You force yourself to calculate backward. Singapore started eighteen months before the accident. Before that, the German acquisition. Before that...') +
                    createDialogue('ALAN', '"I don\'t think I tucked her in once in the last two years of her life."', 'alan') +
                    createNarrator('The admission falls into the room like a stone into still water.');
                },
                choices: [
                    { text: 'Sit with this realization in silence', next: "silence_with_truth", type: "acceptance" },
                    { text: '"I was building a future for her"', next: "future_justification", type: "defense" },
                    { text: '"I can\'t undo that. I can\'t undo any of it."', next: "undoing_impossible", type: "despair" }
                ]
            },

            asking_for_daddy: {
                content: function() {
                    return createDialogue('ALAN', '"She said Lily had been asking for me."', 'alan') +
                    createNarrator('The words come out flat, factual. You\'ve practiced saying this without feeling it.') +
                    createDialogue('NALA', '"What exactly did Sarah say?"', 'nala') +
                    createDialogue('ALAN', '"She said, \'She kept asking where Daddy was. I told her you were coming.\'"', 'alan') +
                    createNarrator('Perfect recall for the words that carved themselves into your chest.') +
                    createDialogue('NALA', '"And what did you say?"', 'nala') +
                    createDialogue('ALAN', '"I said I came as soon as I got the message."', 'alan') +
                    createDialogue('NALA', '"But that wasn\'t true."', 'nala') +
                    createNarrator('No. It wasn\'t true. The first call came at 4:23. You didn\'t leave the conference room until 4:45. Twenty-two minutes of finishing your presentation, fielding questions, shaking hands.') +
                    createDialogue('ALAN', '"I finished the presentation. The Singapore team was already in the room, and—"', 'alan') +
                    createDialogue('NALA', '"You finished a business presentation while your daughter was dying."', 'nala') +
                    createDialogue('ALAN', '"I didn\'t know she was dying. The first call just said accident, emergency room. I thought... broken arm, maybe. Kids get hurt all the time."', 'alan') +
                    createDialogue('NALA', '"What did the second call say?"', 'nala') +
                    createNarrator('The second call. The one that came during the Q&A session. The one you sent to voicemail.') +
                    createDialogue('ALAN', '"I didn\'t take the second call."', 'alan') +
                    createDialogue('NALA', '"Why?"', 'nala') +
                    createDialogue('ALAN', '"Because I was in the middle of something important."', 'alan') +
                    createDialogue('NALA', '"More important than your daughter asking for you while she died?"', 'nala') +
                    createNarrator('The question sits in the air like smoke. Toxic, choking, impossible to escape.');
                },
                choices: [
                    { text: '"Nothing was more important than her."', next: "nothing_more_important", type: "truth" },
                    { text: '"I didn\'t know she was dying."', next: "ignorance_defense", type: "rationalization" },
                    { text: 'Say nothing. Feel everything.', next: "silent_devastation", type: "raw_emotion" }
                ]
            },

            silent_devastation: {
                content: function() {
                    return createNarrator('You say nothing. But for the first time in three years, two months, and sixteen days, you feel everything.') +
                    createNarrator('The guilt sits in your chest like a physical weight. The regret tastes like copper in your mouth. The love you had for her—have for her—burns through your carefully constructed numbness like acid through paper.') +
                    createDialogue('NALA', '"There it is."', 'nala') +
                    createNarrator('Your shoulders shake. When did they start shaking?') +
                    createDialogue('NALA', '"You\'ve been running from this feeling for three years. But it\'s not going anywhere. It\'s part of you now."', 'nala') +
                    createNarrator('Tears. When did you last cry? Not since the funeral. Not since you decided that crying was unproductive, that grief was a luxury you couldn\'t afford.') +
                    createDialogue('ALAN', '"I can\'t... I can\'t live with this."', 'alan') +
                    createDialogue('NALA', '"You\'ve been living with it. You\'ve just been living with it badly."', 'nala') +
                    createNarrator('The office around you feels less real. The numbers on the screen mean nothing. For the first time in years, you are fully present in your own emotional experience.') +
                    createDialogue('NALA', '"What if instead of running from this, you learned to carry it?"', 'nala') +
                    createDialogue('ALAN', '"How? How do you carry something that heavy?"', 'alan') +
                    createDialogue('NALA', '"The same way you carry love. Carefully. With both hands. And not alone."', 'nala') +
                    createNarrator('Not alone. Sarah. When did you stop letting Sarah help carry this?');
                },
                choices: [
                    { text: '"I pushed Sarah away."', next: "sarah_pushed_away", type: "admission" },
                    { text: '"I don\'t know how to not be alone with this."', next: "isolation_confusion", type: "vulnerability" },
                    { text: '"What if I don\'t deserve help carrying it?"', next: "deserve_question", type: "self_worth" }
                ]
            },

            burnt_toast_memory: {
                content: function() {
                    return createDialogue('ALAN', '"Burnt toast. I was reading emails about the Singapore merger and burned the toast."', 'alan') +
                    createNarrator('The smell comes back: acrid, sharp. Lily scraping jam across the black edges, not complaining.') +
                    createDialogue('NALA', '"She ate it anyway."', 'nala') +
                    createDialogue('ALAN', '"She always ate what I made, even when I messed it up."', 'alan') +
                    createNarrator('You realize: you haven\'t made breakfast since. Granola bars, coffee, whatever requires no attention.') +
                    createDialogue('NALA', '"When did you stop cooking?"', 'nala');
                },
                choices: [
                    { text: '"The day after the funeral"', next: "cooking_stopped", type: "precision" },
                    { text: '"I never was good at it anyway"', next: "competence_deflection", type: "self_protection" },
                    { text: '"She deserved better breakfasts"', next: "regret_spiral", type: "guilt" }
                ]
            },

            // FIXED: Added missing scenes that were referenced
            work_worship: {
                content: function() {
                    return createNarrator('2 AM. The coffee has gone cold again. Your eyes burn from screen glare.') +
                    createDialogue('NALA', '"You know what\'s great about spreadsheets? They never ask how you\'re feeling. They never cry. They never... leave."', 'nala') +
                    createNarrator('A flash of memory: small hands, purple crayon, "Daddy, look what I made!"');
                },
                choices: [
                    { text: '"That\'s exactly the point. Numbers don\'t hurt."', next: "embrace_numbness", type: "avoidance" },
                    { text: '"Plus they\'re excellent listeners."', next: "spreadsheet_humor", type: "humor" },
                    { text: '"When did I become someone who prefers data to people?"', next: "self_recognition", type: "growth" }
                ]
            },

            responsibility_lecture: {
                content: function() {
                    return createDialogue('ALAN', '"You don\'t understand responsibility. People depend on me."', 'alan') +
                    createDialogue('NALA', '"Who depended on you at 3:47 PM on Tuesday, April 15th?"', 'nala') +
                    createNarrator('The question hits like a physical blow. A memory tries to surface...') +
                    createDialogue('ALAN', '"Don\'t."', 'alan');
                },
                choices: [
                    { text: '"I won\'t go there"', next: "memory_shutdown", type: "avoidance" },
                    { text: '"What happened on April 15th?"', next: "april_15th", type: "courage" },
                    { text: "Stay silent", next: "silent_processing", type: "withdrawal" }
                ]
            },

            first_crack: {
                content: function() {
                    return createDialogue('ALAN', '"Maybe you have a point. Maybe I do hide behind work."', 'alan') +
                    createDialogue('NALA', '"Hide? Or run? There\'s a difference."', 'nala') +
                    createNarrator('Your phone buzzes. A text from someone named Sarah. You don\'t open it.') +
                    createDialogue('NALA', '"See? Running."', 'nala');
                },
                choices: [
                    { text: "Read Sarah\'s message", next: "sarah_message", type: "courage" },
                    { text: '"I\'ll read it later"', next: "procrastination", type: "avoidance" },
                    { text: '"Who is Sarah?"', next: "sarah_question", type: "confusion" }
                ]
            },

            feelings_spreadsheet: {
                content: function() {
                    return createNarrator('You actually open a file called "Emotional_Metrics_Q4.xlsx"') +
                    createDialogue('NALA', '"Column A: Date. Column B: Emotion. Column C: Productivity Impact. You... you actually quantified grief."', 'nala') +
                    createDialogue('ALAN', '"It helps me track patterns and identify triggers."', 'alan') +
                    createDialogue('NALA', '"Alan, grief isn\'t a quarterly metric. You can\'t optimize heartbreak."', 'nala');
                },
                choices: [
                    { text: '"Why not? Everything else is measurable."', next: "everything_measurable", type: "stoic" },
                    { text: '"It was supposed to help me understand"', next: "understand_attempt", type: "growth" },
                    { text: '"Maybe that\'s the problem"', next: "spreadsheet_realization", type: "growth" }
                ]
            },

            humor_defense: {
                content: function() {
                    return createDialogue('ALAN', '"Humor is how I cope with things. It\'s better than the alternatives."', 'alan') +
                    createDialogue('NALA', '"What alternatives? Feeling? Crying? Being human?"', 'nala') +
                    createDialogue('ALAN', '"Humor keeps me functional."', 'alan') +
                    createDialogue('NALA', '"Functional isn\'t the same as living."', 'nala');
                },
                choices: [
                    { text: '"Functional is enough"', next: "functional_enough", type: "stoic" },
                    { text: '"What\'s wrong with using humor?"', next: "humor_defense_deep", type: "humor" },
                    { text: '"You\'re right. I\'m not really living"', next: "not_living", type: "breakthrough" }
                ]
            },

            humor_awareness: {
                content: function() {
                    return createDialogue('ALAN', '"I use jokes to avoid feeling anything real."', 'alan') +
                    createDialogue('NALA', '"Now we\'re getting somewhere. What are you avoiding?"', 'nala') +
                    createNarrator('Images flash: a hospital room, a small body under white sheets, Sarah\'s breaking voice...') +
                    createDialogue('ALAN', '"Everything. I\'m avoiding everything."', 'alan');
                },
                choices: [
                    { text: '"I can\'t handle the pain"', next: "pain_admission", type: "vulnerability" },
                    { text: '"Tell me what I\'m running from"', next: "running_revelation", type: "courage" },
                    { text: '"Maybe it\'s time to stop running"', next: "stop_running", type: "breakthrough" }
                ]
            },

            // === MAJOR REVELATION SCENES ===
            
            april_15th: {
                content: function() {
                    gameState.flags.lilyRevealed = true;
                    return createDialogue('NALA', '"April 15th, 3:47 PM. Car accident. Six-year-old girl. Lily Grace Chen."', 'nala') +
                    createNarrator('The world tilts. Everything you\'ve been running from crashes down.') +
                    createDialogue('NALA', '"You were in a board meeting discussing Singapore expansion. The call came at 4:23 PM."', 'nala') +
                    createDialogue('ALAN', '"Stop. Please stop."', 'alan');
                },
                choices: [
                    { text: '"I can\'t do this"', next: "shutdown_complete", type: "breakdown" },
                    { text: '"She\'s really gone"', next: "accept_loss", type: "grief" },
                    { text: '"I should have been there"', next: "guilt_spiral", type: "guilt" }
                ]
            },

            sarah_message: {
                content: function() {
                    return createNarrator('You open the message: "Alan, you missed another appointment with Dr. Martinez. I can\'t do this alone anymore."') +
                    createDialogue('ALAN', '"Dr. Martinez?"', 'alan') +
                    createDialogue('NALA', '"Grief counselor. Sarah\'s been trying to get you to go for... how long now?"', 'nala') +
                    createNarrator('Memory surfaces: Sarah begging you to go to therapy, you promising "next week."');
                },
                choices: [
                    { text: '"I don\'t need therapy"', next: "therapy_denial", type: "avoidance" },
                    { text: '"How long have I been avoiding this?"', next: "avoidance_recognition", type: "awareness" },
                    { text: "Call Sarah back", next: "call_sarah", type: "action" }
                ]
            },

            accept_loss: {
                content: function() {
                    return createDialogue('ALAN', '"She\'s really gone. My little girl is dead."', 'alan') +
                    createNarrator('The words hang in the air. For the first time in three years, you\'ve said it out loud.') +
                    createDialogue('NALA', '"Yes. And you\'ve been hiding from that truth ever since."', 'nala') +
                    createDialogue('ALAN', '"How do I live with this?"', 'alan');
                },
                choices: [
                    { text: '"I don\'t know how to grieve"', next: "learning_grief", type: "vulnerability" },
                    { text: '"Sarah tried to help me"', next: "sarah_memory", type: "recognition" },
                    { text: '"I want to remember her properly"', next: "memory_palace_entry", type: "healing" }
                ]
            },

            call_sarah: {
                content: function() {
                    gameState.flags.sarahCalled = true;
                    return createNarrator('You dial her number with shaking hands.') +
                    createDialogue('SARAH', '"Alan? You... you actually called."', 'sarah') +
                    createDialogue('ALAN', '"I got your message about Dr. Martinez."', 'alan') +
                    createDialogue('SARAH', '"That was three days ago. I was starting to think..."', 'sarah') +
                    createNarrator('Her voice cracks. You hear three years of exhaustion.');
                },
                choices: [
                    { text: '"I\'m sorry I\'ve been distant"', next: "sarah_apology", type: "accountability" },
                    { text: '"I\'m ready to try therapy"', next: "therapy_acceptance", type: "growth" },
                    { text: '"I miss you"', next: "miss_sarah", type: "vulnerability" }
                ]
            },

            // === MEMORY PALACE SEQUENCE ===
            
            memory_palace_entry: {
                content: function() {
                    gameState.flags.memoryPalaceEntered = true;
                    return createDialogue('DR. CHEN', '"Alan, you\'ve been talking to Nala for the whole session. Can you tell me about her?"', 'dr-chen') +
                    createDialogue('ALAN', '"She... she helps me think through things."', 'alan') +
                    createDialogue('DR. CHEN', '"What would happen if you tried to hear her less clearly for a moment? Just as an experiment."', 'dr-chen') +
                    createNarrator('Dr. Chen\'s voice grows louder as Nala\'s grows softer. The room feels more solid, more real.') +
                    createDialogue('NALA', '(Faintly) "We\'re not ready to integrate yet..."', 'nala');
                },
                choices: [
                    { text: '"I need Nala right now"', next: "resist_integration", type: "avoidance" },
                    { text: '"Maybe I could try listening to you both"', next: "therapeutic_alliance", type: "growth" },
                    { text: '"What does integration even mean?"', next: "integration_education", type: "curiosity" }
                ]
            },

            therapeutic_alliance: {
                content: function() {
                    return createDialogue('ALAN', '"Maybe I could try listening to both of you."', 'alan') +
                    createDialogue('DR. CHEN', '"That\'s interesting. What do you notice when you hold both voices?"', 'dr-chen') +
                    createDialogue('NALA', '"I\'m not going anywhere. I\'m just... sharing space."', 'nala') +
                    createNarrator('For the first time, the conversation feels three-way rather than internal.') +
                    createDialogue('DR. CHEN', '"Nala seems to serve an important function. What would you say that is, Alan?"', 'dr-chen');
                },
                choices: [
                    { text: '"She protects me from feeling too much"', next: "protection_recognition", type: "insight" },
                    { text: '"She remembers things I can\'t handle"', next: "memory_keeper", type: "awareness" },
                    { text: '"She\'s the part of me that still loves"', next: "love_keeper", type: "breakthrough" }
                ]
            },

            integration_education: {
                content: function() {
                    return createDialogue('ALAN', '"What does integration even mean? Does Nala disappear?"', 'alan') +
                    createDialogue('DR. CHEN', '"Integration isn\'t about elimination. It\'s about coordination. Like... have you ever conducted an orchestra?"', 'dr-chen') +
                    createDialogue('NALA', '"I don\'t want to disappear."', 'nala') +
                    createDialogue('DR. CHEN', '"Nala, what would it be like if Alan could hear the whole orchestra, including you?"', 'dr-chen') +
                    createNarrator('This is new—Dr. Chen addressing Nala directly.');
                },
                choices: [
                    { text: '"You can hear her too?"', next: "therapist_sees_nala", type: "validation" },
                    { text: '"What would the orchestra sound like?"', next: "orchestra_metaphor", type: "curiosity" },
                    { text: '"This is too weird"', next: "retreat_to_normal", type: "resistance" }
                ]
            },

            therapist_sees_nala: {
                content: function() {
                    return createDialogue('DR. CHEN', '"I can\'t hear her the way you do, but I can see her effect on you. Your posture changes when she speaks."', 'dr-chen') +
                    createDialogue('ALAN', '"So I\'m not crazy?"', 'alan') +
                    createDialogue('DR. CHEN', '"You\'re creative. Your mind found a way to process trauma that kept you functional. That\'s adaptation, not pathology."', 'dr-chen') +
                    createDialogue('NALA', '"See? I told you I was helping."', 'nala');
                },
                choices: [
                    { text: '"But is this healthy long-term?"', next: "health_question", type: "practical" },
                    { text: '"What happens in therapy now?"', next: "therapy_process", type: "engagement" },
                    { text: '"I want to understand this better"', next: "understanding_request", type: "growth" }
                ]
            },

            door_lily_realistic: {
                content: function() {
                    gameState.memoriesVisited.lily = true;
                    return createDialogue('DR. CHEN', '"Tell me about an ordinary Tuesday with Lily. Nothing special, just... life."', 'dr-chen') +
                    createNarrator('You close your eyes, reaching past the memorial version toward something smaller, truer.') +
                    createDialogue('ALAN', '"She was building something with blocks. A tower. Kept knocking it down on purpose."', 'alan') +
                    createNarrator('The sound comes back: plastic blocks clattering, her delighted shriek each time.') +
                    createDialogue('ALAN', '"I asked her to play more quietly. I was on a conference call."', 'alan') +
                    createDialogue('DR. CHEN', '"What happened then?"', 'dr-chen') +
                    createDialogue('ALAN', '"She built it taller. Knocked it down louder. Looked right at me while she did it."', 'alan');
                },
                choices: [
                    { text: '"She was testing me"', next: "testing_boundaries", type: "insight" },
                    { text: '"I should have hung up the call"', next: "call_regret", type: "regret" },
                    { text: '"She was being a normal six-year-old"', next: "normal_child", type: "acceptance" }
                ]
            },

            testing_boundaries: {
                content: function() {
                    return createDialogue('ALAN', '"She was testing me. Seeing if work really was more important than play."', 'alan') +
                    createDialogue('DR. CHEN', '"And what did she learn?"', 'dr-chen') +
                    createNarrator('The memory continues: you pointed at your headset, made shushing motions. Her face fell.') +
                    createDialogue('ALAN', '"She learned that calls about quarterly projections mattered more than her games."', 'alan') +
                    createDialogue('NALA', '"She learned that lesson very well."', 'nala') +
                    createDialogue('DR. CHEN', '"How do you feel about that now?"', 'dr-chen');
                },
                choices: [
                    { text: '"Like I taught her to be invisible"', next: "invisibility_lesson", type: "guilt" },
                    { text: '"I was supporting our family"', next: "provider_justification", type: "defense" },
                    { text: '"She deserved my full attention"', next: "attention_recognition", type: "love" }
                ]
            },

            normal_child: {
                content: function() {
                    return createDialogue('ALAN', '"She was being a normal six-year-old. Testing limits, wanting attention, making noise."', 'alan') +
                    createDialogue('DR. CHEN', '"How does it feel to remember her as a normal child instead of..."', 'dr-chen') +
                    createDialogue('ALAN', '"Instead of a saint? Harder. Saints don\'t need parents who pay attention."', 'alan') +
                    createNarrator('You remember other things: her epic meltdowns over wrong-colored plates, her refusal to wear anything but purple for three months.') +
                    createDialogue('NALA', '"Normal children are exhausting. Saints are easier to grieve."', 'nala');
                },
                choices: [
                    { text: '"I miss the exhausting parts too"', next: "missing_difficulty", type: "complexity" },
                    { text: '"Saints don\'t leave socks everywhere"', next: "socks_memory", type: "specificity" },
                    { text: '"I failed a normal child, not a perfect one"', next: "failing_normal", type: "realism" }
                ]
            },

            socks_memory: {
                content: function() {
                    return createDialogue('ALAN', '"Saints don\'t leave socks in the refrigerator. Or put cereal in their shoes. Or sing off-key for forty minutes straight."', 'alan') +
                    createNarrator('The memories surface like physical objects: tiny socks everywhere, impossible places. Sarah always finding them.') +
                    createDialogue('ALAN', '"Sarah used to say Lily was shedding socks like a snake sheds skin."', 'alan') +
                    createDialogue('DR. CHEN', '"What happened to all those socks?"', 'dr-chen') +
                    createNarrator('You know exactly: bagged up the day after the funeral, donated with clothes that smelled like her.');
                },
                choices: [
                    { text: '"We gave them away too fast"', next: "premature_donation", type: "regret" },
                    { text: '"I still find them sometimes"', next: "ghost_socks", type: "haunting" },
                    { text: '"Sarah kept one pair"', next: "sarah_keeping", type: "tenderness" }
                ]
            },

            real_child_recognition: {
                content: function() {
                    return createDialogue('ALAN', '"She was a real kid. She had tantrums about vegetables. She left her socks everywhere."', 'alan') +
                    createDialogue('DR. CHEN', '"What\'s it like to remember her as a whole person instead of just the loss?"', 'dr-chen') +
                    createDialogue('NALA', '"Scarier. But more real."', 'nala') +
                    createDialogue('ALAN', '"If I remember her completely, I have to remember my mistakes too."', 'alan') +
                    createNarrator('The perfect father-daughter relationship in your mind starts to show its real complexity.');
                },
                choices: [
                    { text: '"I wasn\'t a perfect father"', next: "imperfect_father", type: "acceptance" },
                    { text: '"Neither of us was perfect"', next: "mutual_imperfection", type: "wisdom" },
                    { text: '"That makes losing her harder somehow"', next: "complex_grief", type: "depth" }
                ]
            },

            therapy_process_extended: {
                content: function() {
                    return createDialogue('DR. CHEN', '"This work doesn\'t happen in one session, or even ten. What you\'re describing takes time."', 'dr-chen') +
                    createDialogue('ALAN', '"How much time?"', 'alan') +
                    createDialogue('DR. CHEN', '"There\'s no timeline for grief. But integration work? We\'re talking months or years of practice."', 'dr-chen') +
                    createDialogue('NALA', '"Years? I don\'t want to wait years."', 'nala') +
                    createDialogue('DR. CHEN', '"Nala, what feels urgent about this?"', 'dr-chen');
                },
                choices: [
                    { text: '"Sarah can\'t wait years"', next: "sarah_urgency", type: "external_pressure" },
                    { text: '"I want to feel better now"', next: "impatience_with_healing", type: "realistic" },
                    { text: '"What does the process actually look like?"', next: "process_details", type: "practical" }
                ]
            },

            gradual_integration_work: {
                content: function() {
                    return createNarrator('Six weeks of therapy later...') +
                    createDialogue('DR. CHEN', '"How was this week with the homework I gave you?"', 'dr-chen') +
                    createDialogue('ALAN', '"I tried spending ten minutes a day just... feeling whatever came up."', 'alan') +
                    createDialogue('NALA', '"It was horrible. Tuesday he cried for twenty minutes."', 'nala') +
                    createDialogue('DR. CHEN', '"And how did that feel, crying for twenty minutes?"', 'dr-chen') +
                    createDialogue('ALAN', '"Exhausting. But afterwards... quieter."', 'alan');
                },
                choices: [
                    { text: '"The quiet was nice"', next: "appreciating_quiet", type: "progress" },
                    { text: '"I don\'t want to cry every day"', next: "crying_resistance", type: "natural" },
                    { text: '"Sarah noticed I seemed different"', next: "external_validation", type: "relationship" }
                ]
            },

            small_steps_healing: {
                content: function() {
                    return createNarrator('Three months into therapy...') +
                    createDialogue('DR. CHEN', '"What\'s different now compared to when we started?"', 'dr-chen') +
                    createDialogue('ALAN', '"I can think about Lily without immediately reaching for my phone."', 'alan') +
                    createDialogue('NALA', '"Sometimes. Not always."', 'nala') +
                    createDialogue('ALAN', '"Not always. But sometimes is... something."', 'alan') +
                    createDialogue('DR. CHEN', '"Sometimes is huge, actually. How does Sarah see these changes?"', 'dr-chen');
                },
                choices: [
                    { text: '"She says I\'m more present at dinner"', next: "dinner_presence", type: "progress" },
                    { text: '"We had one good conversation about Lily"', next: "lily_conversation", type: "breakthrough" },
                    { text: '"She\'s still frustrated with my pace"', next: "pace_conflict", type: "realistic" }
                ]
            },

            door_sarah: {
                content: function() {
                    gameState.memoriesVisited.sarah = true;
                    return createNarrator('Kitchen table. Sarah sits alone, staring at Lily\'s empty chair.') +
                    createDialogue('SARAH', '"Three years of eating dinner alone while you work late."', 'sarah') +
                    createDialogue('ALAN', '"I\'ve been right here."', 'alan') +
                    createDialogue('SARAH', '"No. You\'ve been absent. I lost my daughter AND my husband that day."', 'sarah') +
                    createNarrator('The weight of her words settles in your chest like lead.');
                },
                choices: [
                    { text: '"I\'m sorry"', next: "simple_apology", type: "accountability" },
                    { text: '"I didn\'t know how to grieve with you"', next: "vulnerability_admission", type: "vulnerability" },
                    { text: '"I want to come back to you"', next: "return_commitment", type: "love" }
                ]
            },

            door_morning: {
                content: function() {
                    gameState.memoriesVisited.lastMorning = true;
                    return createNarrator('April 15th. The last morning. Kitchen full of sunlight and possibilities.') +
                    createDialogue('LILY', '"Daddy, will you walk me to school today?"', 'lily') +
                    createNarrator('Your phone buzzes. Singapore client. Merger crisis. The choice that changed everything.') +
                    createDialogue('ALAN', '"Honey, Daddy has an important call."', 'alan') +
                    createNarrator('She hugged your leg anyway. "Love you, Daddy." Last words. Last touch.');
                },
                choices: [
                    { text: "Relive it differently", next: "relive_differently", type: "redemption" },
                    { text: "Accept what happened", next: "accept_past", type: "acceptance" },
                    { text: '"I choose you, Lily. I choose you now."', next: "choose_lily", type: "love" }
                ]
            },

            // === INTEGRATION PATHS ===
            
            carrying_lily: {
                content: function() {
                    return createDialogue('LILY', '"Carry me in your laughter. In your kindness to other kids. In purple sunsets."', 'lily') +
                    createDialogue('ALAN', '"You want to live through my actions?"', 'alan') +
                    createDialogue('LILY', '"Love never dies, Daddy. It just changes shape."', 'lily') +
                    createNarrator('You feel something shift inside you. Not healing, but... transformation.');
                },
                choices: [
                    { text: '"Love changes shape"', next: "love_transformation", type: "wisdom" },
                    { text: '"I want to help other families"', next: "service_calling", type: "purpose" },
                    { text: '"Show me how to transform this pain"', next: "transformation_request", type: "growth" }
                ]
            },

            vulnerability_admission: {
                content: function() {
                    return createDialogue('ALAN', '"I didn\'t know how to grieve with you. I only knew how to hide."', 'alan') +
                    createDialogue('SARAH', '"We could have helped each other."', 'sarah') +
                    createDialogue('ALAN', '"We still can."', 'alan') +
                    createNarrator('You see a possible future: crying together, healing together, honoring Lily together.');
                },
                choices: [
                    { text: '"Let\'s grieve together"', next: "unified_grief", type: "partnership" },
                    { text: '"I want to learn to be present"', next: "presence_commitment", type: "growth" },
                    { text: '"Teach me how to feel again"', next: "emotional_education", type: "vulnerability" }
                ]
            },

            choose_lily: {
                content: function() {
                    return createNarrator('The scene replays. Your phone buzzes. Singapore client. But this time...') +
                    createDialogue('LILY', '"Daddy, will you walk me to school?"', 'lily') +
                    createNarrator('This time, you put the phone face down on the counter.') +
                    createDialogue('ALAN', '"Of course, baby girl. Always."', 'alan') +
                    createNarrator('Her face lights up like sunrise. This is what choosing love looks like.');
                },
                choices: [
                    { text: '"I choose love now, always"', next: "love_commitment", type: "transformation" },
                    { text: '"This is who I want to be"', next: "identity_shift", type: "integration" },
                    { text: '"I can\'t change the past, but I can honor it"', next: "honor_commitment", type: "wisdom" }
                ]
            },

            // === GRADUAL THERAPY REVELATION SEQUENCE ===
            
            first_therapy_hint: {
                content: function() {
                    return createNarrator('Something feels different about the office tonight. The lighting seems softer, warmer than the harsh fluorescents you remember installing.') +
                    createDialogue('ALAN', '"When did I change the lighting in here?"', 'alan') +
                    createDialogue('NALA', '"Maybe you\'re seeing it differently."', 'nala') +
                    createNarrator('There\'s a calendar on the wall you don\'t remember putting there. Tuesday, Thursday appointments marked in blue ink. "Dr. Chen - 3 PM."') +
                    createDialogue('ALAN', '"Dr. Chen? I don\'t... when did I start seeing a Dr. Chen?"', 'alan') +
                    createDialogue('NALA', '"You\'ve been going for six weeks now. Sarah suggested it."', 'nala') +
                    createNarrator('The memory surfaces like a bubble rising through water: Sarah\'s ultimatum, the business card pressed into your hand, your reluctant agreement.');
                },
                choices: [
                    { text: '"I remember now. The appointment is tomorrow."', next: "appointment_memory", type: "clarity" },
                    { text: '"This office looks different than I thought."', next: "reality_uncertainty", type: "confusion" },
                    { text: '"Have we had this conversation before?"', next: "repetition_awareness", type: "meta" }
                ]
            },

            appointment_memory: {
                content: function() {
                    return createDialogue('ALAN', '"I remember now. The appointment is tomorrow at 3 PM."', 'alan') +
                    createNarrator('The sessions have been... difficult. Dr. Chen asks questions you\'re not ready to answer, suggests exercises you\'re not ready to try.') +
                    createDialogue('NALA', '"She suggested you try talking to me directly."', 'nala') +
                    createDialogue('ALAN', '"Talking to... what? Internal dialogue as therapeutic technique?"', 'alan') +
                    createDialogue('NALA', '"She said I might have things to tell you. That I might have been carrying things you couldn\'t handle."', 'nala') +
                    createNarrator('You remember: Dr. Chen\'s gentle suggestion to "listen to the part of yourself that remembers how to feel." Her explanation of Internal Family Systems theory.') +
                    createDialogue('ALAN', '"This is a guided exercise, isn\'t it? You\'re not... spontaneous."', 'alan') +
                    createDialogue('NALA', '"Does it matter? I\'m still real. I\'m still you."', 'nala');
                },
                choices: [
                    { text: '"Tell me what you\'ve been carrying."', next: "nala_burden_reveal", type: "therapeutic" },
                    { text: '"I want to understand how this works."', next: "therapy_explanation", type: "intellectual" },
                    { text: '"I\'m scared of what you might tell me."', next: "fear_of_truth", type: "vulnerable" }
                ]
            },

            reality_uncertainty: {
                content: function() {
                    return createDialogue('ALAN', '"This office looks different than I thought. Smaller. Warmer."', 'alan') +
                    createNarrator('The walls seem closer together. There are tissues on the side table - when did you start keeping tissues in your office?') +
                    createDialogue('NALA', '"Maybe you\'re not in your office."', 'nala') +
                    createDialogue('ALAN', '"Where else would I be?"', 'alan') +
                    createNarrator('Through the window, instead of the city skyline you expect, there\'s a small garden. A bird feeder. Nothing like the view from your downtown building.') +
                    createDialogue('NALA', '"When was the last time you worked late at the actual office?"', 'nala') +
                    createNarrator('You try to remember: coming home, Sarah already asleep, working in the home office until... but wait. You haven\'t been home in weeks. Sarah left. The apartment is empty.') +
                    createDialogue('ALAN', '"I\'ve been staying at the office. Sleeping on the couch."', 'alan') +
                    createDialogue('NALA', '"Have you? Or have you been sleeping elsewhere?"', 'nala') +
                    createNarrator('The certainty of your location begins to waver. Where exactly are you?');
                },
                choices: [
                    { text: '"Where am I, Nala?"', next: "location_question", type: "disorientation" },
                    { text: '"This feels like a dream."', next: "dream_recognition", type: "awareness" },
                    { text: 'Try to remember arriving here tonight', next: "arrival_memory", type: "investigation" }
                ]
            },

            // === COMPLETE MEMORY PALACE SEQUENCE ===
            
            memory_palace_full: {
                content: function() {
                    return createNarrator('Dr. Chen\'s voice grows distant but doesn\'t disappear entirely.') +
                    createDialogue('DR. CHEN', '(Softly) "You\'re safe, Alan. This is a guided visualization. You can explore any door, or return to the therapy room whenever you choose."', 'dr-chen') +
                    createNarrator('The white space solidifies around you. Three doors, each with distinct characteristics you hadn\'t noticed before.') +
                    '<div class="white-room">' +
                    '<h2>The Architecture of Memory</h2>' +
                    '<p style="font-style: italic; margin-bottom: 30px;">Each door leads to a different understanding. You can visit all of them, in any order.</p>' +
                    '<div style="margin: 30px 0;">' +
                    '<button class="door lily" onclick="enterDoor(\'lily_complete\')">LILY\'S DOOR<br><small style="font-style: italic;">Purple wood, child-height handle</small></button>' +
                    '<button class="door sarah" onclick="enterDoor(\'sarah_complete\')">SARAH\'S DOOR<br><small style="font-style: italic;">Familiar grain, slightly ajar</small></button>' +
                    '<button class="door memory" onclick="enterDoor(\'morning_complete\')">THE MORNING<br><small style="font-style: italic;">Glass door, showing April sunlight</small></button>' +
                    '</div>' +
                    '</div>' +
                    createDialogue('NALA', '"Take your time. We have all the time we need."', 'nala');
                },
                choices: [
                    { text: '"I\'m ready to see all of it."', next: "memory_commitment", type: "courage" },
                    { text: '"Can I go back to Dr. Chen if this gets too intense?"', next: "safety_check", type: "cautious" },
                    { text: '"What happens after I see the memories?"', next: "post_memory_question", type: "future_focused" }
                ]
            },

            door_lily_complete: {
                content: function() {
                    gameState.memoriesVisited.lily = true;
                    return createNarrator('The door opens onto Lily\'s actual bedroom, not a memorial. Clothes on the floor, unmade bed, art supplies scattered across her desk.') +
                    createDialogue('LILY', '"Daddy! You\'re here!"', 'lily') +
                    createNarrator('She\'s six, exactly as she was. Purple everything, gap-toothed grin, sticky fingers from the popsicle she\'s eating.') +
                    createDialogue('ALAN', '"Lily? You\'re..."', 'alan') +
                    createDialogue('LILY', '"I\'m not a ghost, Daddy. I\'m a memory. But I\'m a whole memory, not just the sad parts."', 'lily') +
                    createNarrator('She shows you her current project: a fort made of couch cushions and blankets. "Wanna play? You never play anymore."') +
                    createDialogue('ALAN', '"I... I stopped knowing how to play."', 'alan') +
                    createDialogue('LILY', '"That\'s silly. Playing is easy. You just do what feels fun."', 'lily') +
                    createNarrator('She demonstrates: crawling through the fort, making sound effects, completely absorbed in the adventure of it.') +
                    createDialogue('ALAN', '"What feels fun to you?"', 'alan') +
                    createDialogue('LILY', '"Everything! Except when you\'re too busy to notice. That doesn\'t feel fun."', 'lily') +
                    createNarrator('The comment isn\'t accusatory, just factual. The way children state difficult truths without malice.') +
                    createDialogue('ALAN', '"I was too busy, wasn\'t I?"', 'alan') +
                    createDialogue('LILY', '"Sometimes. But you\'re here now! Do you want to help me finish my fort?"', 'lily');
                },
                choices: [
                    { text: '"Yes. Show me how to help."', next: "play_with_lily", type: "connection" },
                    { text: '"I\'m sorry I was too busy before."', next: "apology_to_lily", type: "accountability" },
                    { text: '"What did you want to tell me that I missed?"', next: "missed_communications", type: "regret" }
                ]
            },

            door_sarah_complete: {
                content: function() {
                    gameState.memoriesVisited.sarah = true;
                    return createNarrator('Sarah sits at your kitchen table, but it\'s not your current kitchen. It\'s the one from five years ago, when Lily was still alive and Sarah still smiled regularly.') +
                    createDialogue('SARAH', '"Alan. I wondered when you\'d visit this memory."', 'sarah') +
                    createNarrator('She\'s folding Lily\'s tiny clothes—a task she used to find meditative before it became archaeological.') +
                    createDialogue('ALAN', '"Sarah, I..."', 'alan') +
                    createDialogue('SARAH', '"Sit down. We need to talk."', 'sarah') +
                    createNarrator('Her voice has an authority you remember from early in your marriage, before grief made her uncertain and your withdrawal made her desperate.') +
                    createDialogue('SARAH', '"Do you remember what you said to me the night before she died?"', 'sarah') +
                    createDialogue('ALAN', '"I... no. I\'m sorry, I don\'t remember."', 'alan') +
                    createDialogue('SARAH', '"You said you were tired of feeling like work was your real life and home was just where you slept between obligations."', 'sarah') +
                    createNarrator('The words hit like cold water. You said that? To Sarah?') +
                    createDialogue('SARAH', '"I told you that home was where your daughter lived, where your wife loved you, where your real life was supposed to happen. Do you remember what you said then?"', 'sarah') +
                    createDialogue('ALAN', '"What did I say?"', 'alan') +
                    createDialogue('SARAH', '"You said someday, when the Singapore deal was done, you\'d have time to be present for your real life. Someday. We ran out of somedays, Alan."', 'sarah');
                },
                choices: [
                    { text: '"I prioritized the wrong things."', next: "wrong_priorities", type: "accountability" },
                    { text: '"I thought I was securing our future."', next: "future_security", type: "defense" },
                    { text: '"What can I do differently now?"', next: "different_now", type: "change_focus" }
                ]
            },

            door_morning_complete: {
                content: function() {
                    gameState.memoriesVisited.lastMorning = true;
                    return createNarrator('April 15th, 6:30 AM. Kitchen full of sunlight and possibility. Lily at the table with cereal, Sarah packing lunch, you checking emails on your phone.') +
                    createDialogue('LILY', '"Daddy, will you walk me to school today?"', 'lily') +
                    createNarrator('This is the moment. You can see all the alternate timelines branching from this choice.') +
                    createDialogue('PHONE', '*BUZZ* Singapore client calling.', 'alan') +
                    createDialogue('ALAN', '(Past self) "Honey, Daddy has a very important call from Singapore."', 'alan') +
                    createDialogue('LILY', '"More important than walking with me?"', 'lily') +
                    createNarrator('Her question hangs in the morning air. In the original timeline, you don\'t really answer it. You just kiss her forehead and take the call.') +
                    createDialogue('NALA', '"You can see what actually happened, or you can experience what might have happened. Which do you need?"', 'nala') +
                    createNarrator('The choice point crystallizes: witness the original pain, or explore the road not taken?') +
                    createDialogue('ALAN', '"Both. I need to see both."', 'alan') +
                    createNarrator('The scene splits into two simultaneous experiences: your actual choice and the choice you wish you\'d made.');
                },
                choices: [
                    { text: 'Experience the original timeline - taking the call', next: "original_choice", type: "truth" },
                    { text: 'Experience the alternate timeline - walking with Lily', next: "alternate_choice", type: "healing" },
                    { text: 'Hold both possibilities simultaneously', next: "dual_awareness", type: "integration" }
                ]
            },

            // === SARAH DEVELOPMENT - REAL VOICE AND AGENCY ===
            
            sarah_phone_call_real: {
                content: function() {
                    return createNarrator('Your phone rings. Sarah\'s name on the screen. This isn\'t a memory - this is happening now, in the therapy room.') +
                    createDialogue('DR. CHEN', '"You can take it, Alan. Stay connected to both experiences - the call and the therapeutic space."', 'dr-chen') +
                    createNarrator('You answer.') +
                    createDialogue('SARAH', '"Alan? Dr. Chen said you might be ready to talk."', 'sarah') +
                    createDialogue('ALAN', '"Sarah. I... yes. I think I am."', 'alan') +
                    createDialogue('SARAH', '"How are you feeling right now? Not thinking - feeling."', 'sarah') +
                    createNarrator('The question she\'s learned to ask in her own therapy. Sarah has been doing work too.') +
                    createDialogue('ALAN', '"Scared. Hopeful. Like I\'m meeting parts of myself I\'d forgotten existed."', 'alan') +
                    createDialogue('SARAH', '"I\'m proud of you for doing this work. And I\'m angry that it took a separation for you to start."', 'sarah') +
                    createNarrator('Both things true simultaneously. The complexity of real relationship.') +
                    createDialogue('NALA', '"Tell her you understand her anger."', 'nala') +
                    createDialogue('ALAN', '"I understand your anger. I would be angry too if someone I loved chose emotional unavailability for three years."', 'alan') +
                    createDialogue('SARAH', '"Three years? Try ten, Alan. Lily\'s death didn\'t make you emotionally unavailable. It just made it impossible to ignore anymore."', 'sarah');
                },
                choices: [
                    { text: '"You\'re right. This pattern is older than I realized."', next: "pattern_recognition", type: "accountability" },
                    { text: '"What would you need to see to believe I can change?"', next: "change_evidence", type: "commitment" },
                    { text: '"Can you tell me about your experience of our marriage?"', next: "sarah_perspective", type: "curiosity" }
                ]
            },

            sarah_perspective: {
                content: function() {
                    return createDialogue('ALAN', '"Can you tell me about your experience of our marriage?"', 'alan') +
                    createDialogue('SARAH', '"Which version? The first two years when you were present and engaged? Or the last eight when I felt like I was married to a very productive ghost?"', 'sarah') +
                    createNarrator('Her words are precise, considered. She\'s thought about this extensively.') +
                    createDialogue('SARAH', '"I grieved our marriage long before I grieved our daughter, Alan. By the time Lily died, I\'d already been mourning the loss of my husband for years."', 'sarah') +
                    createDialogue('ALAN', '"I was right there. I was working to provide for us."', 'alan') +
                    createDialogue('SARAH', '"You were physically present and emotionally absent. Do you know what that\'s like? Living with someone who shares your bed but not your life?"', 'sarah') +
                    createDialogue('NALA', '"Let her finish. Don\'t defend yet."', 'nala') +
                    createDialogue('SARAH', '"After Lily died, I needed my husband. Not my provider, not my co-manager of logistics - my husband. The person who loved me enough to grieve with me instead of at me."', 'sarah') +
                    createDialogue('ALAN', '"I didn\'t know how to grieve with you."', 'alan') +
                    createDialogue('SARAH', '"You didn\'t try to learn. You just... disappeared deeper into work and expected me to understand that was how you coped."', 'sarah') +
                    createNarrator('Every word feels both devastating and clarifying. Truth often does.');
                },
                choices: [
                    { text: '"I want to learn how to grieve with you now."', next: "grief_partnership", type: "commitment" },
                    { text: '"What would emotional presence look like to you?"', next: "presence_definition", type: "learning" },
                    { text: '"I understand if you can\'t trust this change."', next: "trust_understanding", type: "acceptance" }
                ]
            },

            // === INTEGRATION PRACTICE SCENES ===
            
            integration_practice_daily: {
                content: function() {
                    return createNarrator('Two weeks after the session. You\'re practicing what Dr. Chen calls "conscious co-presence" with Nala during ordinary activities.') +
                    createDialogue('ALAN', '(Making coffee) "Nala, how am I feeling about the day ahead?"', 'alan') +
                    createDialogue('NALA', '"Anxious about the client meeting, sad that Sarah isn\'t here to drink coffee with you, grateful that you\'re asking me instead of just pushing through."', 'nala') +
                    createNarrator('This is the practice: emotional awareness as daily routine, not crisis management.') +
                    createDialogue('ALAN', '"What do I need to remember during the meeting?"', 'alan') +
                    createDialogue('NALA', '"That the client is a person, not just a revenue stream. That you can be competent and compassionate simultaneously."', 'nala') +
                    createNarrator('You set a phone reminder: "Check in with Nala" every two hours. Integration as skill-building, not magic.') +
                    createNarrator('At the meeting, you notice the client\'s stress level, respond to their underlying concerns, not just their surface requests. Work becomes more human.') +
                    createDialogue('CLIENT', '"You really listen. Most consultants just solve the problem I think I have, not the one I actually have."', 'alan') +
                    createNarrator('Emotional intelligence as competitive advantage. Who knew?');
                },
                choices: [
                    { text: 'Practice integration during a difficult conversation', next: "integration_conflict", type: "skill_building" },
                    { text: 'Try integration during a moment of grief', next: "integration_grief", type: "emotional" },
                    { text: 'Use integration to call Sarah', next: "integration_sarah_call", type: "relationship" }
                ]
            },

            integration_conflict: {
                content: function() {
                    return createNarrator('Your business partner questions a decision you made based on "gut feeling" rather than pure data analysis.') +
                    createDialogue('PARTNER', '"This recommendation doesn\'t make financial sense. Where are the numbers supporting this approach?"', 'alan') +
                    createNarrator('Old you would defend with more numbers, escalate the conflict, or capitulate entirely.') +
                    createDialogue('ALAN', '(Internally) "Nala, what am I feeling right now?"', 'alan') +
                    createDialogue('NALA', '"Defensive because he\'s questioning your judgment. Also frustrated because you know you\'re right but can\'t prove it with data."', 'nala') +
                    createDialogue('ALAN', '"What does he need from me?"', 'alan') +
                    createDialogue('NALA', '"Security. He\'s scared of making a mistake. Show him how emotional intelligence reduces risk."', 'nala') +
                    createDialogue('ALAN', '(To partner) "You\'re right to want data. Let me explain how reading client emotional state reduces implementation risk by about 40%, based on our track record."', 'alan') +
                    createNarrator('Integration in action: feeling your emotions, understanding others\' emotions, responding to actual needs rather than surface positions.') +
                    createDialogue('PARTNER', '"Oh. I see. You\'re not abandoning analysis - you\'re adding another data source."', 'alan') +
                    createNarrator('Conflict resolved through inclusion rather than dominance.');
                },
                choices: [
                    { text: 'Teach the partner about emotional data', next: "emotional_education", type: "teaching" },
                    { text: 'Reflect on how this felt different', next: "conflict_reflection", type: "learning" },
                    { text: 'Practice this approach in other areas', next: "approach_expansion", type: "growth" }
                ]
            },

            // === EXTERNAL STAKES AND URGENCY ===
            
            sarah_ultimatum_real: {
                content: function() {
                    return createNarrator('Three months into therapy. Sarah calls with news that changes everything.') +
                    createDialogue('SARAH', '"Alan, I need to tell you something. I\'ve been offered a position in Portland. Department head at the university."', 'sarah') +
                    createNarrator('Portland. Three thousand miles away. A life without you.') +
                    createDialogue('ALAN', '"That\'s... that\'s wonderful, Sarah. You\'ve wanted something like this for years."', 'alan') +
                    createDialogue('NALA', '"Tell her how you feel about the distance."', 'nala') +
                    createDialogue('ALAN', '"I\'m terrified you\'ll take it and I\'ll lose any chance to rebuild what we had."', 'alan') +
                    createDialogue('SARAH', '"Alan, you need to understand something. I\'m going to take this position unless you can show me - really show me - that you\'re committed to doing this emotional work long-term."', 'sarah') +
                    createNarrator('Six weeks. That\'s how long before she needs to give them an answer.') +
                    createDialogue('SARAH', '"I won\'t spend another decade married to someone who treats emotional connection like optional overtime."', 'sarah') +
                    createDialogue('ALAN', '"What would I need to show you?"', 'alan') +
                    createDialogue('SARAH', '"That you can be emotionally present during conflict. That you can talk about Lily without shutting down. That you can prioritize our relationship over work demands when it matters."', 'sarah') +
                    createNarrator('Concrete goals. A timeline. Real stakes.');
                },
                choices: [
                    { text: '"I want to fight for our marriage."', next: "marriage_fight", type: "commitment" },
                    { text: '"What would emotional presence during conflict look like?"', next: "conflict_skills", type: "learning" },
                    { text: '"I understand if you need to take the job regardless."', next: "acceptance_with_love", type: "selfless" }
                ]
            },

            work_crisis_integration: {
                content: function() {
                    return createNarrator('Four months into therapy. Your biggest client threatens to leave due to "personality conflicts" with your team.') +
                    createDialogue('CLIENT', '"Your technical work is excellent, but your team dynamic is toxic. People seem afraid to disagree with each other."', 'client') +
                    createNarrator('The old you would panic, blame team members, work eighteen-hour days to fix it through pure effort.') +
                    createDialogue('NALA', '"What if this is an opportunity to practice emotional leadership?"', 'nala') +
                    createDialogue('ALAN', '"How do I lead emotionally?"', 'alan') +
                    createDialogue('NALA', '"Start by understanding why people are afraid to disagree. Then create safety for authentic conflict."', 'nala') +
                    createNarrator('You schedule individual conversations with each team member. Not performance reviews - emotional check-ins.') +
                    createDialogue('TEAM_MEMBER', '"Honestly? People are afraid you\'ll shut down any idea that complicates the timeline. We\'ve learned to just agree with whatever you suggest."', 'alan') +
                    createNarrator('The feedback stings because it\'s accurate. You\'ve been managing people like variables in a spreadsheet.') +
                    createDialogue('ALAN', '"What would you need from me to feel safe disagreeing?"', 'alan') +
                    createNarrator('Integration applied to leadership: emotional intelligence as business skill.');
                },
                choices: [
                    { text: 'Restructure team meetings to encourage conflict', next: "conflict_encouragement", type: "leadership" },
                    { text: 'Share your integration work with the team', next: "vulnerability_leadership", type: "transparency" },
                    { text: 'Ask the client to observe your next team meeting', next: "client_observation", type: "accountability" }
                ]
            },

            choose_integration: {
                content: function() {
                    gameState.flags.emotionalBreakthrough = true;
                    return createDialogue('ALAN', '"I choose integration. I choose wholeness."', 'merged') +
                    createNarrator('The two chairs merge into one. You sit, feeling complete for the first time in years.') +
                    createDialogue('ALAN', '"I am productive AND feeling. Efficient AND loving. I don\'t have to choose."', 'merged') +
                    createDialogue('NALA', '"That\'s what healthy looks like."', 'nala') +
                    createNarrator('You feel Nala\'s presence shifting, becoming part of you rather than separate from you.');
                },
                choices: [
                    { text: '"I feel whole"', next: "surface_integrated", type: "completion" },
                    { text: '"I want to call Sarah now"', next: "surface_connected", type: "action" },
                    { text: '"I know my purpose"', next: "surface_purposeful", type: "clarity" }
                ]
            },

            need_both: {
                content: function() {
                    return createDialogue('ALAN', '"I need both parts. Logic and emotion. Productivity and love."', 'merged') +
                    createDialogue('NALA', '"Balance. That\'s what we\'ve been working toward."', 'nala') +
                    createNarrator('The two chairs don\'t merge but move closer together. Partnership, not integration.') +
                    createDialogue('ALAN', '"We can work together. You handle feelings, I handle tasks."', 'alan');
                },
                choices: [
                    { text: '"Let\'s be partners"', next: "nala_partnership", type: "collaboration" },
                    { text: '"I want full integration eventually"', next: "gradual_integration", type: "growth" },
                    { text: '"This feels right for now"', next: "surface_balanced", type: "acceptance" }
                ]
            },

            // === SURFACE RETURN SEQUENCES ===
            
            // === THE REVELATION: ALAN AND NALA ARE ONE ===
            
            therapy_room_reveal: {
                content: function() {
                    return createNarrator('The office dissolves. No—not dissolves. Reveals itself. You\'re not in your home office. You\'re in a small, warm room with soft lighting and two comfortable chairs.') +
                    createDialogue('DR. CHEN', '"Alan? Can you hear me?"', 'dr-chen') +
                    createNarrator('A woman sits across from you, notepad in her lap, concern in her eyes. Dr. Chen. You remember now—you\'ve been coming here for... how long?') +
                    createDialogue('ALAN', '"I... where am I?"', 'alan') +
                    createDialogue('DR. CHEN', '"You\'re in my office. We\'ve been working together for three months now. You were under hypnosis—guided visualization to help you access the parts of yourself you\'ve disconnected from."', 'dr-chen') +
                    createNarrator('Hypnosis. The home office, the voice, Nala—all of it happened in your mind, guided by therapeutic suggestion.') +
                    createDialogue('NALA', '"I\'m still here."', 'nala') +
                    createNarrator('Her voice is quieter now, but present. Not external—internal. Not a hallucination, but a genuine part of your psyche that you\'ve finally allowed to speak.') +
                    createDialogue('DR. CHEN', '"How are you feeling? You\'ve been accessing some very deep material."', 'dr-chen') +
                    createDialogue('ALAN', '"Nala... she\'s not separate from me. She\'s me."', 'alan') +
                    createDialogue('DR. CHEN', '"Yes. Nala is the part of you that carries emotional memory, the part that loved fully and felt deeply before the trauma. In therapy, we call this Internal Family Systems—different parts of the psyche that develop to handle different aspects of experience."', 'dr-chen') +
                    createDialogue('NALA', '"I\'m the part of you that never stopped loving her."', 'nala') +
                    createDialogue('ALAN', '"And I\'m the part that couldn\'t handle losing her."', 'alan');
                },
                choices: [
                    { text: '"How long have you been there, Nala?"', next: "nala_history", type: "curiosity" },
                    { text: '"Can other people have internal voices like this?"', next: "normalizing_question", type: "validation" },
                    { text: '"What happens now that I can hear you?"', next: "integration_future", type: "hope" }
                ]
            },

            nala_history: {
                content: function() {
                    return createDialogue('ALAN', '"How long have you been there, Nala?"', 'alan') +
                    createDialogue('NALA', '"Always. I\'m the voice that used to remind you to call Sarah, to play with Lily, to notice sunsets. You used to listen to me."', 'nala') +
                    createDialogue('DR. CHEN', '"When did that change, do you think?"', 'dr-chen') +
                    createDialogue('ALAN', '"Gradually. Work got more demanding. I started trusting logic over intuition, productivity over presence."', 'alan') +
                    createDialogue('NALA', '"And then after Lily died, you locked me away completely. The part of you that felt love felt too dangerous."', 'nala') +
                    createNarrator('You remember now: the months after the funeral when any emotion felt like a threat to your sanity. Work became medication.') +
                    createDialogue('DR. CHEN', '"Alan, what Nala represents—your capacity for deep feeling, for love, for connection—that never went away. It just got buried under protective mechanisms."', 'dr-chen') +
                    createDialogue('ALAN', '"So when I was talking to myself all these years..."', 'alan') +
                    createDialogue('NALA', '"You were talking to me. You just couldn\'t hear me talking back."', 'nala') +
                    createDialogue('DR. CHEN', '"In hypnosis, we created a safe space for that internal dialogue to become explicit, conscious. What you experienced was real—it was your psyche learning to integrate its different parts."', 'dr-chen') +
                    createNarrator('Integration. Not elimination of grief, but integration of love and loss, productivity and presence, logic and emotion.');
                },
                choices: [
                    { text: '"I want to learn to hear you without hypnosis."', next: "conscious_integration", type: "commitment" },
                    { text: '"What would integration actually look like in daily life?"', next: "practical_integration", type: "practical" },
                    { text: '"I\'m scared of feeling everything I\'ve been avoiding."', next: "fear_of_feeling", type: "honesty" }
                ]
            },

            conscious_integration: {
                content: function() {
                    return createDialogue('ALAN', '"I want to learn to hear you without hypnosis, Nala. I want to learn to be... whole."', 'alan') +
                    createDialogue('DR. CHEN', '"That\'s beautiful, Alan. And it\'s possible. Integration work takes time and practice, but many people learn to maintain conscious dialogue with different parts of themselves."', 'dr-chen') +
                    createDialogue('NALA', '"I don\'t want to disappear again."', 'nala') +
                    createDialogue('ALAN', '"You won\'t. I won\'t let you. I need... I need the part of me that knows how to love."', 'alan') +
                    createNarrator('The words surprise you with their truth. For three years, you\'ve been trying to function without your capacity for love, thinking it was too dangerous.') +
                    createDialogue('DR. CHEN', '"What would you say to that six-year-old part of yourself that\'s been carrying all this grief alone?"', 'dr-chen') +
                    createNarrator('Six-year-old part? You think of Lily, but also... the part of you that loved her with childlike completeness.') +
                    createDialogue('ALAN', '"I would say... I\'m sorry I left you alone with something so big. I\'m sorry I thought protecting you meant ignoring you."', 'alan') +
                    createDialogue('NALA', '"And I would say... I forgive you. And I\'m tired of carrying this alone."', 'nala') +
                    createDialogue('DR. CHEN', '"What would it look like to carry it together?"', 'dr-chen') +
                    createNarrator('Together. The word feels foreign after years of radical independence, but also... hopeful.');
                },
                choices: [
                    { text: '"I want to call Sarah. With Nala\'s help."', next: "sarah_call_integrated", type: "relationship" },
                    { text: '"I want to visit Lily\'s grave. Together."', next: "grave_visit_integrated", type: "memorial" },
                    { text: '"I want to learn to feel without drowning."', next: "feeling_without_drowning", type: "skill_building" }
                ]
            },

            sarah_call_integrated: {
                content: function() {
                    return createDialogue('ALAN', '"I want to call Sarah. But this time, I want Nala to help me remember how to be emotionally present."', 'alan') +
                    createDialogue('DR. CHEN', '"What would that look like?"', 'dr-chen') +
                    createDialogue('NALA', '"It would mean feeling your love for her while you\'re talking, not just thinking about logistics."', 'nala') +
                    createDialogue('ALAN', '"It would mean telling her about this—about learning to feel again, about discovering this part of myself."', 'alan') +
                    createNarrator('The idea terrifies you. Sarah left because you\'d become emotionally unavailable. What if she doesn\'t trust this change?') +
                    createDialogue('NALA', '"What if she does? What if she\'s been waiting for exactly this?"', 'nala') +
                    createDialogue('DR. CHEN', '"Alan, would you like to practice that conversation here first? With Nala\'s help?"', 'dr-chen') +
                    createNarrator('Practice. Yes. You can practice being emotionally present the way you once practiced presentations.') +
                    createDialogue('ALAN', '"Yes. I want to practice loving my wife out loud."', 'alan') +
                    createNarrator('The phrase surprises you: loving out loud. When did you start loving silently, internally, assumed rather than expressed?') +
                    createDialogue('NALA', '"Tell her about the morning you made her coffee and watched her read. Before everything got complicated."', 'nala') +
                    createNarrator('You remember: Sarah in morning light, completely absorbed in a novel, unconsciously beautiful. You brought her coffee and stood in the doorway just to watch her exist.');
                },
                choices: [
                    { text: 'Practice telling Sarah about that morning', next: "practice_love_memory", type: "vulnerable" },
                    { text: '"I want to tell her about Nala."', next: "explain_nala_to_sarah", type: "transparency" },
                    { text: '"I want to ask what she needs from me."', next: "sarah_needs_question", type: "other_focused" }
                ]
            },

            practice_love_memory: {
                content: function() {
                    return createDialogue('ALAN', '"Sarah, I want to tell you about a morning I remember. You were reading in the kitchen, and I brought you coffee."', 'alan') +
                    createNarrator('Speaking to the empty air feels silly, but Dr. Chen nods encouragingly.') +
                    createDialogue('NALA', '"Tell her how she looked."', 'nala') +
                    createDialogue('ALAN', '"You were so absorbed in your book that you didn\'t notice me standing there. The morning light was making your hair golden, and you were completely present in that moment, and I thought... I thought I could watch you read forever."', 'alan') +
                    createNarrator('The memory becomes vivid as you speak it. How long since you\'ve told Sarah something beautiful about her?') +
                    createDialogue('NALA', '"Tell her why you stopped telling her things like that."', 'nala') +
                    createDialogue('ALAN', '"I stopped telling you beautiful things about yourself because I started thinking that loving you was something I did privately, internally, while I worked to provide for you externally. But I realize now that love needs to be spoken, witnessed, shared."', 'alan') +
                    createDialogue('DR. CHEN', '"How does it feel to say that out loud?"', 'dr-chen') +
                    createDialogue('ALAN', '"Scary. Real. True."', 'alan') +
                    createDialogue('NALA', '"And necessary. She can\'t see your internal love. Nobody can."', 'nala') +
                    createNarrator('You think of all the years of silent appreciation, unexpressed gratitude, love assumed rather than declared.');
                },
                choices: [
                    { text: '"I want to make that call now."', next: "real_sarah_call", type: "courage" },
                    { text: '"I need to prepare more first."', next: "preparation_time", type: "cautious" },
                    { text: '"What if she doesn\'t believe I\'ve changed?"', next: "change_credibility", type: "fear" }
                ]
            },

            surface_connected: {
                content: function() {
                    return createNarrator('You pick up your phone with steady hands. No trembling, no hesitation.') +
                    createDialogue('SARAH', '"Alan?"', 'sarah') +
                    createDialogue('ALAN', '"Sarah. I\'m different. I\'m... integrated. Whole."', 'merged') +
                    createDialogue('SARAH', '"You sound different. Present. Really present."', 'sarah') +
                    createDialogue('ALAN', '"I am. For the first time in three years. Will you have coffee with me?"', 'merged');
                },
                choices: [
                    { text: '"Can we try again?"', next: "ending_marriage_renewal" },
                    { text: '"I want to grieve with you"', next: "ending_shared_healing" },
                    { text: '"Let\'s honor Lily together"', next: "ending_memorial_together" }
                ]
            },

            surface_balanced: {
                content: function() {
                    return createNarrator('Dr. Chen\'s office. You feel... balanced. Not whole, but functional in a deeper way.') +
                    createDialogue('NALA', '"We did it. We found equilibrium."', 'nala') +
                    createDialogue('DR. CHEN', '"You seem different, Alan. More present but also more purposeful."', 'dr-chen') +
                    createDialogue('ALAN', '"I\'ve learned to work with all parts of myself."', 'alan');
                },
                choices: [
                    { text: "Focus on rebuilding with Sarah", next: "ending_partnership_healing" },
                    { text: "Start a support group for other grievers", next: "ending_peer_support" },
                    { text: "Take grief counseling slow and steady", next: "ending_steady_progress" }
                ]
            },

            // === FALLBACK SCENES FOR MISSING CONNECTIONS ===
            
            // These handle any remaining dead ends by routing to appropriate scenes
            memory_shutdown: {
                content: function() {
                    return createDialogue('ALAN', '"I won\'t go there. I can\'t."', 'alan') +
                    createDialogue('NALA', '"The memories will find you anyway. They always do."', 'nala') +
                    createNarrator('You bury yourself deeper in work, but the ghosts are persistent.');
                },
                choices: [
                    { text: "Continue avoiding", next: "avoidance_spiral", type: "avoidance" },
                    { text: '"Maybe another time"', next: "procrastination", type: "delay" },
                    { text: '"Help me face this"', next: "courage_request", type: "growth" }
                ]
            },

            avoidance_spiral: {
                content: function() {
                    return createNarrator('Three months later. You\'ve become a ghost in your own life.') +
                    createDialogue('NALA', '"This isn\'t working, Alan. Avoidance is killing us both."', 'nala') +
                    createNarrator('Sarah has stopped calling. Your coworkers treat you like fragile glass.') +
                    createDialogue('ALAN', '"I\'m fine."', 'alan') +
                    createDialogue('NALA', '"You\'re not fine. You\'re disappearing."', 'nala');
                },
                choices: [
                    { text: '"Maybe disappearing is easier"', next: "ending_fade_away" },
                    { text: '"I\'m tired of being a ghost"', next: "late_awakening", type: "breakthrough" },
                    { text: '"What would Lily want?"', next: "lily_perspective", type: "wisdom" }
                ]
            },

            late_awakening: {
                content: function() {
                    return createDialogue('ALAN', '"I\'m tired of being a ghost in my own life."', 'alan') +
                    createDialogue('NALA', '"Then let\'s become real again. Together."', 'nala') +
                    createNarrator('It\'s never too late to choose healing over hiding.');
                },
                choices: [
                    { text: '"Show me how to become real"', next: "memory_palace_entry", type: "courage" },
                    { text: '"I need professional help"', next: "therapy_acceptance", type: "wisdom" }
                ]
            },

            // Emergency routing for any unhandled scenes
            fallback_scene: {
                content: function() {
                    return createNarrator('You find yourself at a crossroads, unsure which path led you here.') +
                    createDialogue('NALA', '"We seem to have lost our way. But that\'s okay. Healing isn\'t linear."', 'nala') +
                    createDialogue('ALAN', '"What do I do now?"', 'alan') +
                    createDialogue('NALA', '"Choose what feels right. There\'s no wrong answer here."', 'nala');
                },
                choices: [
                    { text: "Face the memories", next: "memory_palace_entry", type: "courage" },
                    { text: "Focus on the present", next: "surface_integrated", type: "acceptance" },
                    { text: "Start over", next: "restart_journey", type: "reset" }
                ]
            }
        };

        // COMPREHENSIVE ENDING COLLECTION
        const endings = {
            ending_love_integration: {
                title: "Love, Integrated",
                content: `<p><strong>Six months later.</strong></p>
                <p>You and Sarah renew your vows in Lily's memorial garden. Purple flowers everywhere, just as she would have loved.</p>
                <p>"We're not the same people who lost her," you say, your voice steady and warm. "We're the people her love taught us to become."</p>
                <p>Sarah wears a small purple ribbon. You carry Lily's broken crayon in your pocket—not as a weight, but as a reminder of beauty even in brokenness.</p>
                <em>Some love grows deeper through loss, not despite it.</em>`
            },

            ending_wounded_healer: {
                title: "The Wounded Healer",
                content: `<p><strong>Two years later.</strong></p>
                <p>Your grief counseling practice serves 200 families annually. Parents travel across the country to work with "the counselor who truly understands."</p>
                <p>Your office wall displays Lily's artwork alongside client testimonials. Every session begins the same way: "I've been where you are. Love doesn't end with death—it transforms."</p>
                <p>Nala helps you stay emotionally present with each client while maintaining healthy boundaries.</p>
                <em>Sometimes the broken places become the strongest places.</em>`
            },

            ending_memorial_creation: {
                title: "Living Memorial",
                content: `<p><strong>Eighteen months later.</strong></p>
                <p>The Lily Grace Foundation provides art therapy for grieving children. Purple crayons are always available, along with every other color a heart could need.</p>
                <p>"Art is the language of the heart," you tell parents. "Even broken hearts speak beauty."</p>
                <p>Every child who passes through the program leaves a purple handprint on the memory wall. Lily's is there too, preserved from when she was three.</p>
                <em>Some memorials are built from healing hands, not stone.</em>`
            },

            ending_marriage_renewal: {
                title: "Second Chances",
                content: `<p><strong>One year later.</strong></p>
                <p>You and Sarah move to a small house with a garden. Every morning, you tend Lily's purple flowers together, talking about dreams and memories.</p>
                <p>"We're learning to grieve as a team," Sarah says, her hand finding yours among the blooms. "It's harder and better than grieving alone."</p>
                <p>Some evenings, you read stories aloud to the garden. Different stories than you should have read that night, but stories nonetheless.</p>
                <em>Some marriages must be rebuilt, not just repaired.</em>`
            },

            // === ENDING MODIFICATIONS FOR REALISM ===
            // === ENDINGS EXPANDED FOR EMOTIONAL DEPTH ===
            
            ending_love_learns_to_speak: {
                title: "Love Learns to Speak",
                content: `<p><strong>Six months later.</strong></p>
                <p>You and Sarah are learning to love out loud again. It's clumsy at first—like learning a language you once spoke fluently but haven't practiced in years.</p>
                <p>"I love how you organize the spice cabinet," you tell her Tuesday morning, watching her methodical precision. "I love that you read the same page twice when something moves you."</p>
                <p>She looks up, surprised by your attention to details you'd stopped noticing during the years of emotional automation.</p>
                <p>"I love that you're learning to see me again," she says. "Not just the logistics of me, but... me."</p>
                <p>Nala helps you notice these moments—the micro-expressions of affection you used to miss while calculating quarterly projections in your head during dinner conversations.</p>
                <p>Some nights you tell Sarah about your day from Nala's perspective: what you felt, not just what you accomplished. Some nights she shares her internal landscape too—the parts of herself she'd protected during your years of emotional unavailability.</p>
                <p>Lily's presence in your marriage isn't a wound anymore, but a shared language of love that continues beyond loss.</p>
                <em>Some couples learn to love each other a second time, more consciously.</em>`
            },

            ending_letters_to_lily: {
                title: "Letters to a Daughter",
                content: `<p><strong>One year, four months later.</strong></p>
                <p>Every Sunday, you write Lily a letter. Not to process grief—Dr. Chen helped you understand that grief doesn't need processing, just integration—but to maintain relationship with love that continues.</p>
                <p>"Dear Lily," this week's letter begins. "Nala and I learned something new about sadness this week. It's not the opposite of joy—it's joy's twin sister, the one who reminds us that what we loved was real."</p>
                <p>The letters aren't sentimental. They're specific, honest, sometimes funny. You tell her about Sarah's new job, about learning to cook (badly), about the morning you found one of her socks in the couch cushions and cried in the kitchen for twenty minutes.</p>
                <p>"I don't write to you because I think you're reading over my shoulder," you write. "I write to you because loving you is still part of who I am, and love this big needs expression."</p>
                <p>Nala helps you remember her voice, her questions, her way of seeing the world. In the letters, she grows older with you—nine now, ten, eleven. Not frozen at six, but evolving as your understanding of her deepens.</p>
                <p>Sarah reads them sometimes. "You're a better father in these letters," she observes, "than you were able to be in life."</p>
                <p>"I'm learning," you tell her. "Love learns."</p>
                <em>Some relationships continue through conscious choice rather than physical presence.</em>`
            },

            ending_integration_mastery: {
                title: "The Architecture of Wholeness",
                content: `<p><strong>Two years later.</strong></p>
                <p>Other people are learning to live with their Nalas now. Dr. Chen refers clients to you—not for therapy, but for consultation on what integration actually feels like in daily life.</p>
                <p>"Tell them about the morning meetings," Nala suggests as you prepare for a consultation call.</p>
                <p>You explain to the new client: "Every morning, I check in with different parts of myself. Nala handles emotional navigation. The Protector handles practical concerns. The Critic offers quality control. They all get input, but I make the final decisions."</p>
                <p>"It sounds complicated," the client says.</p>
                <p>"It's the opposite," you explain. "It's simpler than fighting with yourself constantly, or pretending you don't have conflicting needs and values."</p>
                <p>Your work has evolved too. You still do financial consulting, but now you specialize in helping companies develop what you call "emotional architecture"—systems for making decisions that honor both profit and people.</p>
                <p>"Numbers serve life," you tell corporate clients. "Not the other way around."</p>
                <p>Nala keeps you honest. When a project feels like old-style emotional avoidance disguised as professional expertise, she calls you on it.</p>
                <p>Sarah watches this evolution with amazement and sometimes concern. "Don't lose yourself completely," she warns gently.</p>
                <p>"I'm not losing myself," you assure her. "I'm finally finding all of myself."</p>
                <em>Some people become fluent in the language of their own complexity.</em>`
            },

            ending_still_learning: {
                title: "Still Learning",
                content: `<p><strong>Eighteen months of practice.</strong></p>
                <p>Integration isn't a destination—it's a daily practice, like meditation or exercise. Some days you're fluent in the language of your own emotions. Other days you fall back into old patterns of productive avoidance.</p>
                <p>"I had a Nala-less day yesterday," you tell Dr. Chen during your monthly check-in. "Worked fourteen hours straight, avoided two texts from Sarah, ate granola bars for dinner."</p>
                <p>"What brought you back?" she asks.</p>
                <p>"This morning I was making coffee and heard myself humming one of Lily's songs. Nala said, 'I missed you.'"</p>
                <p>The work continues: learning to notice when you disconnect, developing strategies for coming back to emotional presence, practicing the art of loving people out loud instead of just internally.</p>
                <p>Sarah joins you for couples sessions now—not to fix your marriage, but to learn how to have a relationship where both people include their whole selves.</p>
                <p>"We're like emotional archaeologists," she observes, "excavating parts of ourselves we buried for protection."</p>
                <p>Some evenings you cook dinner together and tell each other what you felt that day, not just what you accomplished. It's awkward still, like learning to dance after years of walking only in straight lines.</p>
                <p>But love, you're learning, grows more interesting with practice, not less.</p>
                <em>Some practices become ways of life, gradually, imperfectly, beautifully.</em>`
            },

            ending_lily_as_person: {
                title: "Remembering a Daughter",
                content: `<p><strong>Three years later.</strong></p>
                <p>You can finally talk about Lily's difficult phases: her anxiety about starting first grade, her jealousy when friends got better presents, the way she tested boundaries by leaving toys everywhere.</p>
                <p>"She was wonderfully, frustratingly human," you tell her picture. Not the sanitized memorial version, but the real six-year-old who lived in your house.</p>
                <p>You've donated her clothes but kept the ones that smell like her. You've given away most toys but kept the broken ones she loved best.</p>
                <p>Grief counseling has taught you: she was your daughter, not your angel. That makes losing her harder and more real.</p>
                <em>Some memories honor the person, not just the loss.</em>`
            },

            ending_shared_healing: {
                title: "Together in Grief",
                content: `<p><strong>Eight months later.</strong></p>
                <p>You and Sarah attend grief counseling together. Not to fix your marriage, but to honor your daughter by learning to grieve as a team.</p>
                <p>"We're not trying to get over Lily," you tell Dr. Martinez. "We're learning to carry her love forward together."</p>
                <p>Some sessions you cry. Some sessions you laugh remembering her silly jokes. All sessions, you hold hands.</p>
                <em>Some griefs are too big to carry alone.</em>`
            },

            ending_partnership_healing: {
                title: "The Nala Partnership",
                content: `<p><strong>Two years later.</strong></p>
                <p>You've developed a thriving therapeutic practice using "internal dialogue therapy." Clients learn to work with their inner voices rather than against them.</p>
                <p>"This is Nala," you tell new clients. "She handles my emotional processing while I manage the logistics. Teamwork."</p>
                <p>Other therapists are fascinated by your approach. Nala enjoys the professional recognition.</p>
                <em>Some partnerships are eternal, some are internal.</em>`
            },

            // === ENHANCED ENDING FOR LITERARY DEPTH ===
            ending_ishiguro_style: {
                title: "The Things We Keep",
                content: `<p><strong>Two years, three months, sixteen days later.</strong></p>
                <p>You still count time this way sometimes, though less obsessively now. Dr. Chen calls it "anniversary thinking"—the way grief keeps its own calendar.</p>
                <p>Sarah found Lily's sock this morning, wedged behind the washing machine. Purple with yellow polka dots. We both stared at it for longer than necessary before I put it in the memory box, next to the broken crayon and the math homework with eraser holes.</p>
                <p>I make breakfast now. Never toast—oatmeal, eggs, things that require attention. Sarah says I've become careful with food in a way that suggests I'm learning to be careful with other things too.</p>
                <p>Nala doesn't talk as much during the day anymore, but she's there when I'm cooking, making sure I don't burn things. Making sure I taste what I'm making. Some mornings I catch myself setting three places at the table before remembering.</p>
                <p>We're not the same people who lost a daughter. We're not trying to be.</p>
                <em>Some griefs teach us how to love more carefully, not less.</em>`
            },

            ending_memory_archaeology: {
                title: "Archaeological Layers",
                content: `<p><strong>Eighteen months of excavation.</strong></p>
                <p>Therapy has become a kind of archaeology. Each session, Dr. Chen helps us uncover another layer: the parent I was, the parent I thought I was, the parent I might still become to the children I'll never have.</p>
                <p>"Memory is sedimentary," she explains. "We're not changing what happened. We're learning to read the layers differently."</p>
                <p>Today I remembered Lily's terrible dinosaur jokes. How she'd wait for the punchline to land, face bright with expectation. How I'd groan dramatically just to see her giggle. Small performances of connection I'd forgotten under the weight of everything that came after.</p>
                <p>Nala helps me distinguish between the memories that serve love and the memories that serve guilt. It's delicate work, like separating fossil from stone.</p>
                <em>Some stories emerge slowly, in fragments, over years of careful excavation.</em>`
            },

            ending_ordinary_tuesdays: {
                title: "Tuesday, Again",
                content: `<p><strong>A Tuesday like others.</strong></p>
                <p>Nothing remarkable happens today. I burn the eggs slightly but eat them anyway. Sarah mentions her sister is pregnant again—our third niece or nephew since Lily died. The world continues making children.</p>
                <p>"How do you feel about that?" has become a question I can answer without consulting Nala first, though she still offers commentary from whatever corner of my mind she's claimed as permanent residence.</p>
                <p>I feel happy for Sarah's sister. I feel sad we won't give this child a cousin. I feel grateful for love that continues and sorry for love that ended too soon. I feel multiple things simultaneously, which Dr. Chen assures me is both normal and healthy.</p>
                <p>Lily would be nine now. Old enough for terrible dinosaur jokes and complex feelings about new babies. Old enough for some things, too young for others. We'll never know which.</p>
                <p>But today, for the first time, that unknowing feels like part of love rather than proof of its failure.</p>
                <em>Some Tuesdays become ordinary again, and that itself is extraordinary.</em>`
            },

            ending_fade_away: {
                title: "The Ghost Life",
                content: `<p><strong>Five years later.</strong></p>
                <p>You exist but don't live. Work, sleep, repeat. Sarah has remarried and moved on. You send birthday cards to her daughter—not Lily, but the new one.</p>
                <p>Nala has grown quiet, defeated. "We could still choose differently," she whispers sometimes.</p>
                <p>You've perfected the art of being alive without living. It's a skill no one should master.</p>
                <em>Some choices lead to slow disappearance.</em>`
            },

            ending_meta_breakthrough: {
                title: "Breaking the Fourth Wall",
                content: `<p><strong>Outside of narrative time.</strong></p>
                <p>"Wait," you say to Nala. "Someone's been making choices FOR me this whole time?"</p>
                <p>Nala consults her notes. "Apparently. And they made some... interesting decisions about our emotional development."</p>
                <p>You look directly at the reader. "Did you at least choose growth over avoidance?"</p>
                <p>Nala shrugs. "They got us here. That's something."</p>
                <em>Some stories know they're stories. Some healers know they're being witnessed.</em>`
            }
        };

        // ENHANCED GAME FUNCTIONS

        function updateGameState(choiceType) {
            switch(choiceType) {
                case 'stoic':
                    gameState.stoicScore = Math.min(10, gameState.stoicScore + 1);
                    break;
                case 'humor':
                    gameState.humorScore = Math.min(10, gameState.humorScore + 1);
                    break;
                case 'growth':
                case 'breakthrough':
                case 'vulnerability':
                case 'wisdom':
                case 'courage':
                    gameState.growthScore = Math.min(10, gameState.growthScore + 1);
                    if (choiceType === 'breakthrough') gameState.flags.emotionalBreakthrough = true;
                    break;
                case 'integration':
                case 'partnership':
                case 'healing':
                case 'collaboration':
                    gameState.integrationScore = Math.min(10, gameState.integrationScore + 1);
                    break;
                case 'avoidance':
                case 'breakdown':
                case 'delay':
                    gameState.avoidanceLevel = Math.min(10, gameState.avoidanceLevel + 1);
                    break;
                case 'love':
                case 'accountability':
                case 'action':
                    gameState.marriagePotential = Math.min(5, gameState.marriagePotential + 1);
                    break;
                case 'blame':
                    gameState.marriagePotential = Math.max(-5, gameState.marriagePotential - 1);
                    break;
            }

            // Update Nala relationship based on scores
            if (gameState.integrationScore >= 8) {
                gameState.nalaRelationship = 'integrated';
            } else if (gameState.integrationScore >= 5) {
                gameState.nalaRelationship = 'collaborative';
            } else if (gameState.growthScore >= 4) {
                gameState.nalaRelationship = 'neutral';
            } else if (gameState.avoidanceLevel >= 6) {
                gameState.nalaRelationship = 'adversarial';
            }
        }

        function updateUI() {
            // Visual theme updates based on emotional state
            let state = 'Disconnected';
            if (gameState.avoidanceLevel >= 7) {
                state = 'Shutdown';
                document.body.className = 'fractured';
            } else if (gameState.stoicScore >= 6) {
                state = 'Numbed';
                document.body.className = 'numb';
            } else if (gameState.humorScore >= 6) {
                state = 'Deflecting';
                document.body.className = 'numb';
            } else if (gameState.integrationScore >= 8) {
                state = 'Integrated';
                document.body.className = 'transcendent';
            } else if (gameState.integrationScore >= 5) {
                state = 'Healing';
                document.body.className = 'healing';
            } else if (gameState.growthScore >= 6) {
                state = 'Awakening';
                document.body.className = 'awakening';
            }
        }

        function makeChoice(choiceId) {
            if (gameState.gameEnded) return;
            
            // Find choice type for state updates
            let choiceType = 'neutral';
            for (let sceneKey in scenes) {
                const scene = scenes[sceneKey];
                if (scene.choices) {
                    const choice = scene.choices.find(c => c.next === choiceId);
                    if (choice) {
                        choiceType = choice.type;
                        break;
                    }
                }
            }
            
            gameState.choiceHistory.push({ choice: choiceId, type: choiceType });
            updateGameState(choiceType);
            
            // Smart routing for story progression
            if (choiceId.startsWith('ending_')) {
                showEnding(choiceId);
            } else if (scenes[choiceId]) {
                showScene(choiceId);
            } else {
                // Fallback routing for missing scenes
                console.warn('Scene not found:', choiceId, '- routing to fallback');
                
                if (gameState.sceneCount >= 8 && !gameState.flags.emotionalBreakthrough) {
                    showScene('integration_chamber');
                } else if (!gameState.flags.memoryPalaceEntered && gameState.growthScore >= 3) {
                    showScene('memory_palace_entry');
                } else {
                    showScene('fallback_scene');
                }
            }
            
            updateUI();
        }

        function enterDoor(doorType) {
            makeChoice('door_' + doorType);
        }

        function showScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) {
                console.error('Scene truly not found:', sceneId);
                showScene('fallback_scene');
                return;
            }
            
            gameState.sceneCount++;
            
            const container = document.getElementById('gameContainer');
            const currentScene = document.querySelector('.scene.active');
            
            if (currentScene) {
                currentScene.classList.remove('active');
                setTimeout(() => currentScene.remove(), 800);
            }
            
            const newScene = document.createElement('div');
            newScene.className = 'scene';
            newScene.id = 'scene_' + sceneId;
            
            newScene.innerHTML = typeof scene.content === 'function' ? scene.content() : scene.content;
            
            if (scene.choices && scene.choices.length > 0) {
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'choices';
                
                scene.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = `choice ${choice.type || ''}`;
                    button.textContent = choice.text;
                    button.onclick = () => makeChoice(choice.next);
                    choicesDiv.appendChild(button);
                });
                
                newScene.appendChild(choicesDiv);
            }
            
            container.appendChild(newScene);
            setTimeout(() => newScene.classList.add('active'), 50);
            
            gameState.currentScene = sceneId;
        }

        function showEnding(endingKey) {
            gameState.gameEnded = true;
            
            // More realistic ending selection based on game state
            if (!endings[endingKey]) {
                if (gameState.integrationScore >= 8 && gameState.marriagePotential >= 2) {
                    endingKey = 'ending_realistic_marriage';
                } else if (gameState.integrationScore >= 7) {
                    endingKey = 'ending_therapy_partnership';
                } else if (gameState.integrationScore >= 5) {
                    endingKey = 'ending_gradual_integration';
                } else if (gameState.marriagePotential >= 2) {
                    endingKey = 'ending_shared_healing';
                } else if (gameState.avoidanceLevel >= 8) {
                    endingKey = 'ending_fade_away';
                } else {
                    endingKey = 'ending_slow_and_steady';
                }
            }
            
            const ending = endings[endingKey];
            
            const container = document.getElementById('gameContainer');
            const currentScene = document.querySelector('.scene.active');
            
            if (currentScene) {
                currentScene.classList.remove('active');
                setTimeout(() => currentScene.remove(), 800);
            }
            
            const endingScene = document.createElement('div');
            endingScene.className = 'scene ending';
            endingScene.innerHTML = `
                <div class="ending">
                    <h2>${ending.title}</h2>
                    <div class="ending-text">
                        ${ending.content}
                    </div>
                    <button class="restart-button" onclick="restart()">Begin Again</button>
                </div>
            `;
            
            container.appendChild(endingScene);
            setTimeout(() => endingScene.classList.add('active'), 50);
        }

        function restart() {
            location.reload();
        }

        // Initialize
        updateUI();
    </script>
</body>
</html>
